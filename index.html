<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Laporan Progres Hafalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1f2937;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(229, 231, 235, 0.8);
            --nav-bg: rgba(255, 255, 255, 0.8);
            --nav-border: rgba(229, 231, 235, 0.9);
            --input-bg: rgba(249, 250, 251, 0.8);
            --input-border: rgba(209, 213, 219, 0.8);
            --input-focus-bg: #fff;
            --skeleton-bg: #e5e7eb;
            --skeleton-highlight: #f3f4f6;
            --subtle-text: #4b5563;
            --hover-bg: rgba(0, 0, 0, 0.04);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .glass-card, .glass-modal-content { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--card-border); box-shadow: 0 4px 20px 0 rgba(31, 38, 135, 0.08); }
        .glass-nav { background: var(--nav-bg); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-color: var(--nav-border) !important; }
        .glass-input { background-color: var(--input-bg) !important; border: 1px solid var(--input-border) !important; }
        .glass-input:focus { background-color: var(--input-focus-bg) !important; border-color: #f59e0b !important; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
        .nav-link { transition: all 0.2s ease-in-out; color: var(--subtle-text); }
        .nav-link:hover { background-color: var(--hover-bg); color: #d97706; }
        .nav-link.active { background-color: rgba(251, 191, 36, 0.1); color: #d97706; font-weight: 600; }
        .nav-link.active svg { color: #d97706; }
        .profile-card, .stat-card, .animated-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .profile-card:hover, .stat-card:hover, .animated-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .section-header { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--card-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .section-header svg { color: var(--subtle-text); }
        .footer-bg { background-color: #111827; background-image: radial-gradient(circle at 1px 1px, #374151 1px, transparent 0); background-size: 20px 20px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .skeleton { position: relative; overflow: hidden; background-color: var(--skeleton-bg); }
        .skeleton::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.2) 20%, rgba(255,255,255,0.5) 60%, rgba(255,255,255,0)); animation: shimmer 1.5s infinite; }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.6s ease-out forwards; opacity: 0; }
        
        /* Components */
        #toast { visibility: hidden; transition: transform 0.5s, opacity 0.5s; opacity: 0; transform: translate(-50%, 100px); }
        #toast.show { visibility: visible; opacity: 1; transform: translate(-50%, 0); }
        .modal { transition: opacity 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(-20px); }
        .accordion-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding: 0; }
        .progress-ring-circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .skeleton-container { position: absolute; inset: 0; background: var(--bg-color); z-index: 20; overflow: hidden; }
        .tab-peringkat.active, .analisis-tab.active { color: #d97706; }
        .tab-peringkat.active { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .analisis-tab.active { border-color: #d97706; background-color: rgba(251, 191, 36, 0.1); }
        .tahfizh-tab.active { color: #d97706; border-color: #d97706; }
        .stat-card-blue { background-image: linear-gradient(to right, #3b82f6, #2563eb); }
        .stat-card-green { background-image: linear-gradient(to right, #22c55e, #16a34a); }
        .stat-card-red { background-image: linear-gradient(to right, #ef4444, #dc2626); }
        .pagination-btn { transition: all 0.2s ease; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background-color: #f59e0b; color: white; border-color: #f59e0b; }
    </style>
</head>
<body class="text-gray-900">
    <div class="sm:flex min-h-screen">
        <nav class="fixed bottom-0 left-0 w-full border-t sm:relative sm:w-64 sm:flex-shrink-0 sm:border-r sm:border-t-0 z-30 glass-nav">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div>
                    <span class="font-bold text-lg">Setor.in</span>
                </div>
                <div id="main-nav" class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-beranda" title="Beranda" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs sm:text-sm">Beranda</span></a>
                    <a href="#" data-page="page-analisis" title="Analisis Santri" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-xs sm:text-sm">Analisis</span></a>
                    <a href="#" data-page="page-riwayat" title="Riwayat Setoran" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-xs sm:text-sm">Riwayat</span></a>
                    <a href="#" data-page="page-rekap" title="Rekapitulasi" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs sm:text-sm">Rekap</span></a>
                </div>
            </div>
        </nav>

        <main id="main-content" class="flex-1 pb-20 sm:pb-0 overflow-y-auto relative">
            <div id="skeleton-container" class="absolute inset-0 bg-[var(--bg-color)] z-20 p-8 space-y-8">
                <div class="h-40 skeleton rounded-2xl"></div><div class="h-40 skeleton rounded-2xl"></div>
                <div class="h-48 skeleton rounded-2xl"></div><div class="h-32 skeleton rounded-2xl"></div>
            </div>
            
            <div id="page-beranda" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-8">
                    <header>
                        <div class="flex flex-col lg:grid lg:grid-cols-4 lg:grid-rows-2 gap-4">
                            <div id="datetime-container" class="animated-card order-1 lg:col-span-2 glass-card p-6 rounded-2xl flex items-center justify-center"></div>
                            <div class="animated-card order-2 lg:order-none md:col-span-2 lg:col-span-2 lg:row-span-2 bg-gradient-to-br from-amber-400 to-orange-500 text-white p-6 rounded-2xl flex flex-col justify-between">
                                <div><h2 class="text-lg font-medium opacity-90 mb-2">Assalamu 'alaikum,</h2><h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Selamat Datang di Laporan Setor.in</h1><p class="mt-4 text-base opacity-90 max-w-md">Pantau progres hafalan santri secara transparan.</p></div>
                                <div class="flex items-center gap-3 mt-6"><div class="bg-white/20 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div><span class="font-bold text-lg">Setor.in</span></div>
                            </div>
                            <button data-target-page="page-analisis" class="animated-card order-3 lg:order-none lg:col-span-2 bg-gray-800 hover:bg-gray-900 text-white p-6 rounded-2xl text-left flex flex-col justify-between group transition-all duration-300 shadow-lg hover:shadow-xl">
                                <div class="flex-grow"><h3 class="text-2xl font-bold">Lihat Analisis Santri</h3><p class="text-gray-300 mt-1">Pilih santri untuk melihat detail progres hafalan.</p></div>
                                <div class="flex justify-end mt-4"><div class="bg-amber-500 p-3 rounded-full group-hover:bg-amber-400 group-hover:scale-110 transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg></div></div>
                            </button>
                        </div>
                    </header>
                    <section class="animate-slide-up" style="animation-delay: 100ms;">
                        <h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>Statistik Umum</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div data-stat-type="aktif" class="stat-card stat-card-blue text-white p-5 rounded-2xl shadow-lg flex items-center gap-4 cursor-pointer"><div class="bg-white/20 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div><div><p class="text-sm font-semibold opacity-90">Santri Aktif (Bulan Ini)</p><p id="stats-santri-aktif" class="text-2xl font-bold">0 / 0</p></div></div>
                            <div data-stat-type="tuntas" class="stat-card stat-card-green text-white p-5 rounded-2xl shadow-lg flex items-center gap-4 cursor-pointer"><div class="bg-white/20 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="text-sm font-semibold opacity-90">Sudah Tuntas</p><p id="stats-santri-tuntas" class="text-2xl font-bold">0</p></div></div>
                            <div data-stat-type="belum-tuntas" class="stat-card stat-card-red text-white p-5 rounded-2xl shadow-lg flex items-center gap-4 cursor-pointer"><div class="bg-white/20 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="text-sm font-semibold opacity-90">Belum Tuntas</p><p id="stats-santri-belum-tuntas" class="text-2xl font-bold">0</p></div></div>
                        </div>
                    </section>
                    <section id="target-ketuntasan-section" class="animate-slide-up" style="animation-delay: 200ms;"></section>
                    <section class="animate-slide-up" style="animation-delay: 300ms;"><h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Progres Ketuntasan Juz Wajib</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div id="mutqin-unggulan-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-unggulan-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-sky-800 mt-3 mb-1">Santri Unggulan (1/2 Juz 30)</h3><p id="mutqin-unggulan-details" class="text-xs text-sky-700"></p></div><div id="mutqin-juz30-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-juz30-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-green-800 mt-3 mb-1">Tahfizh (Mutqin Juz 30)</h3><p id="mutqin-juz30-details" class="text-xs text-green-700"></p></div><div id="mutqin-juz29-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-juz29-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-amber-800 mt-3 mb-1">Tahfizh (Mutqin Juz 29)</h3><p id="mutqin-juz29-details" class="text-xs text-amber-700"></p></div></div></section>
                    <section id="peringkat-section" class="animate-slide-up" style="animation-delay: 400ms;"></section>
                    <section id="tuntas-tracking-section" class="animate-slide-up" style="animation-delay: 500ms;"><h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Lacak Ketuntasan per Kelas</h3><div id="tuntas-tracking-accordion" class="space-y-2"></div></section>
                    <section id="target-tuntas-tracking-section" class="animate-slide-up" style="animation-delay: 600ms;"></section>
                    
                    <footer class="mt-12 pt-8 footer-bg text-white rounded-2xl p-8">
                        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 text-center md:text-left">
                            <div>
                                <div class="flex items-center justify-center md:justify-start gap-3"><div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div><span class="font-bold text-lg">Setor.in</span></div>
                                <p class="mt-2 text-sm text-gray-400">Memudahkan pemantauan progres hafalan santri secara modern dan transparan.</p>
                            </div>
                            <div>
                                <h4 class="font-semibold">Kontak & Dukungan</h4>
                                <ul class="mt-2 space-y-1 text-sm">
                                    <li><a href="https://wa.me/6285339213109" target="_blank" class="text-amber-400 hover:underline flex items-center gap-2 justify-center md:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>Beri Masukan (WhatsApp)</a></li>
                                    <li><a href="#" id="footer-help-button" class="text-amber-400 hover:underline flex items-center gap-2 justify-center md:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 2.21-1.79 4-4 4-1.742 0-3.223-.835-3.772-2M12 18v.01" /></svg>Bantuan & FAQ</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-8 pt-8 border-t border-gray-700 text-center text-xs text-gray-500">&copy; 2025 - Dibuat untuk Asrama 1 Abu Bakar Ash-Shiddiq.</div>
                    </footer>
                </div>
            </div>

            <div id="page-analisis" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-4xl mx-auto">
                    <div class="pt-12 sm:pt-0 mb-8 fade-in">
                        <h2 class="text-2xl sm:text-3xl font-bold flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Analisis Progres Santri</h2>
                        <p class="text-[var(--subtle-text)] mt-2 sm:pl-11">Pilih santri untuk melihat detail progres hafalan secara individu.</p>
                    </div>
                    <div class="mb-6 fade-in" style="animation-delay: 100ms;">
                        <label for="santri-select-analisis" class="block text-sm font-medium mb-1">Pilih Nama Santri</label>
                        <select id="santri-select-analisis" class="w-full p-3 rounded-lg glass-input transition-all"></select>
                    </div>
                    <div id="analisis-content-container"></div>
                </div>
            </div>

            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg> Riwayat Setoran</h2><p class="text-[var(--subtle-text)] mt-2 sm:pl-11">Cari dan filter riwayat setoran.</p></div>
                    <div class="p-4 rounded-xl mb-6 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 items-end glass-card"><div class="lg:col-span-1"><label for="search-riwayat" class="text-sm font-medium">Cari Santri</label><div class="relative"><input type="search" id="search-riwayat" placeholder="Ketik nama..." class="w-full mt-1 p-2 rounded-lg glass-input" autocomplete="off"><div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden"></div></div></div><div><label for="filter-program" class="text-sm font-medium">Program</label><select id="filter-program" class="w-full mt-1 p-2 rounded-lg glass-input"><option value="Semua">Semua Program</option><option value="Tahfizh">Tahfizh</option><option value="Unggulan">Unggulan</option></select></div><div><label for="filter-kelas" class="text-sm font-medium">Kelas</label><select id="filter-kelas" class="w-full mt-1 p-2 rounded-lg glass-input"><option value="Semua">Semua Kelas</option><option value="2A">2A</option><option value="2B">2B</option><option value="2C">2C</option><option value="2D">2D</option><option value="2G">2G</option><option value="2H">2H</option><option value="2CDGH">2CDGH</option></select></div><div><label for="filter-tanggal-mulai" class="text-sm font-medium">Dari</label><input type="date" id="filter-tanggal-mulai" class="w-full mt-1 p-2 rounded-lg glass-input"></div><div><label for="filter-tanggal-akhir" class="text-sm font-medium">Sampai</label><input type="date" id="filter-tanggal-akhir" class="w-full mt-1 p-2 rounded-lg glass-input"></div></div>
                    <div id="icon-legend-riwayat" class="mb-6"></div>
                    <div id="content-riwayat" class="rounded-2xl overflow-hidden glass-card overflow-x-auto"><table class="min-w-full"><thead class="glass-nav border-b border-[var(--nav-border)] sticky top-0 z-10"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Detail</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hidden sm:table-cell">Tanggal</th></tr></thead><tbody id="setoranTableBody" class="divide-y divide-[var(--card-border)]"></tbody></table></div>
                    <div id="riwayat-pagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center text-sm gap-4"></div>
                </div>
            </div>
            
            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Rekapitulasi Setoran</h2><p class="text-[var(--subtle-text)] mt-2 sm:pl-11">Pantau perkembangan dan ekspor laporan per kelas.</p></div>
                    <div id="icon-legend-rekap" class="mb-6"></div>
                    <div id="content-rekap" class="rounded-2xl p-5 glass-card">
                        <div class="mb-6"><label for="rekap-select" class="block text-sm font-medium mb-1">Pilih Tampilan Rekap</label><select id="rekap-select" class="w-full p-3 rounded-lg glass-input transition-all"></select></div>
                        <div id="rekap-content-container"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="helpModal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-lg relative z-50 p-6 rounded-2xl glass-modal-content max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold flex items-center gap-2"><svg class="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 2.21-1.79 4-4 4-1.742 0-3.223-.835-3.772-2M12 18v.01" /></svg>Bantuan & FAQ</h3><button id="closeHelpModal" class="p-1 rounded-full text-2xl leading-none hover:bg-[var(--hover-bg)]">&times;</button></div>
            <div class="text-sm space-y-4 text-[var(--subtle-text)]">
                <div><h4 class="font-semibold text-[var(--text-color)] mb-1">Penjelasan Istilah</h4><ul class="list-disc list-inside space-y-1"><li><strong>Mutqin:</strong> Setoran untuk menguji kelancaran hafalan satu juz penuh (atau setengah juz 30) yang sudah selesai dimuraja'ah.</li><li><strong>Muraja'ah:</strong> Setoran untuk mengulang hafalan yang sudah pernah disetor sebelumnya untuk menjaga kelancaran.</li><li><strong>Ziyadah:</strong> Setoran hafalan baru (tambahan hafalan). Hanya tersedia untuk santri Tahfizh yang sudah Tuntas.</li></ul></div>
                <div><h4 class="font-semibold text-[var(--text-color)] mb-1">Bagaimana Penilaian Bekerja?</h4><p>Nilai 100 diberikan jika santri (Unggulan & Tahfizh) berhasil menyelesaikan setoran <strong>Mutqin Setengah Juz 30</strong> sebelum tanggal deadline yang ditentukan.</p></div>
                <div><h4 class="font-semibold text-[var(--text-color)] mb-1">Apa Syarat Tuntas?</h4><ul class="list-disc list-inside space-y-1"><li><strong>Program Unggulan:</strong> Mencapai nilai 100.</li><li><strong>Program Tahfizh:</strong> Mencapai nilai 100 DAN menyelesaikan Mutqin Juz 30 & Juz 29 sebelum deadline.</li></ul></div>
                <p class="mt-6 text-xs text-center">Jika ada pertanyaan lebih lanjut, silakan hubungi pengurus.</p>
            </div>
        </div>
    </div>

    <div id="peringkatModal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-md relative z-50 p-6 rounded-2xl glass-modal-content max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h3 id="peringkatModalTitle" class="text-lg font-bold">Peringkat Top 10</h3><button id="closePeringkatModal" class="p-1 rounded-full text-2xl leading-none hover:bg-[var(--hover-bg)]">&times;</button></div>
            <div id="peringkatModalContent" class="text-sm space-y-2"></div>
        </div>
    </div>
    
    <div id="statListModal" class="modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-md relative z-50 p-6 rounded-2xl glass-modal-content max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h3 id="statListModalTitle" class="text-lg font-bold">Daftar Santri</h3><button id="closeStatListModal" class="p-1 rounded-full text-2xl leading-none hover:bg-[var(--hover-bg)]">&times;</button></div>
            <div id="statListModalContent" class="text-sm space-y-2"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 z-50 flex items-center gap-3 bg-gray-900/80 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700/50 backdrop-blur-sm"><svg id="toast-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg><span id="toast-message"></span></div>

    <template id="history-row-template"><tr class="hover:bg-[var(--hover-bg)] transition-colors"><td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="font-medium data-nama"></div><div class="flex items-center shrink-0 ml-2 data-icons"></div></div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--subtle-text)]"><div><span class="data-jenis font-semibold text-[var(--text-color)]"></span> <span class="data-juz-text"></span></div><div class="text-xs data-unit"></div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--subtle-text)] hidden sm:table-cell data-tanggal"></td></tr></template>
    <template id="rekap-content-template"><div class="rekap-tab-content"><div class="bg-white/20 p-4 rounded-t-xl border-b border-[var(--card-border)] flex flex-col sm:flex-row justify-between items-start sm:items-center"><div><h3 class="font-bold text-amber-700 text-lg data-title"></h3><p class="text-sm text-[var(--subtle-text)] data-musyrif"></p><p class="text-xs text-gray-500 data-timestamp"></p></div></div><div class="overflow-x-auto bg-white/10 p-2 rounded-b-xl"><table class="min-w-full divide-y divide-[var(--card-border)]"><thead class="bg-transparent"><tr class="border-b border-gray-200/80"><th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">No.</th><th class="sortable px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 rounded-l-lg" data-sort="nama">Nama <span class="sort-icon"></span></th><th class="sortable px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="nilai">Nilai <span class="sort-icon"></span></th><th class="sortable px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="ziyadah">Ziyadah <span class="sort-icon"></span></th><th class="sortable px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 rounded-r-lg" data-sort="keterangan">Keterangan <span class="sort-icon"></span></th></tr></thead><tbody class="divide-y divide-[var(--card-border)] data-table-body"></tbody></table></div></div></template>
    <template id="analisis-dashboard-template"><div class="space-y-8"><div class="profile-card-new glass-card rounded-2xl flex flex-col fade-in shadow-lg overflow-hidden"><div class="p-6 bg-gradient-to-br from-amber-400 to-orange-500 text-white relative"><div class="flex items-center gap-4"><div class="relative flex-shrink-0"><div class="w-20 h-20 bg-white/30 rounded-full flex items-center justify-center border-4 border-white/50 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div></div><div class="flex-grow"><h3 class="font-bold text-xl sm:text-2xl" data-name>Nama Santri</h3><div class="flex items-center gap-4 text-sm opacity-90 mt-1"><span class="flex items-center gap-1.5" data-kelas-text></span><span class="flex items-center gap-1.5" data-program-text></span></div></div></div></div><div class="p-6 bg-white/50 grid grid-cols-3 gap-4 text-center"><div class="font-semibold"><p class="text-sm text-[var(--subtle-text)]">Status Tuntas</p><div data-status-badge class="mt-1 text-xs font-bold px-3 py-1 rounded-full inline-block"></div></div><div class="font-semibold"><p class="text-sm text-[var(--subtle-text)]">Nilai Akhir</p><p class="text-2xl mt-1" data-nilai></p></div><div class="font-semibold"><p class="text-sm text-[var(--subtle-text)]">Perpulangan</p><div data-perpulangan-badge class="mt-1 text-xs font-bold px-3 py-1 rounded-full inline-block"></div></div></div></div><div class="fade-in" style="animation-delay: 100ms;"><div class="flex border-b border-[var(--card-border)]" id="analisis-tabs"><button class="analisis-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" data-target="analisis-ringkasan">Ringkasan</button><button class="analisis-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" data-target="analisis-aktivitas">Aktivitas</button></div></div><div><div id="analisis-ringkasan" class="analisis-tab-content fade-in"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-6"><div class="grid grid-cols-2 gap-4"><div class="stat-card glass-card p-4 rounded-xl text-center"><p class="text-sm font-medium text-[var(--subtle-text)]">Total Setoran</p><p class="text-3xl font-bold mt-1" data-total-setoran></p></div><div class="stat-card glass-card p-4 rounded-xl text-center"><p class="text-sm font-medium text-[var(--subtle-text)]">Total Ziyadah</p><p class="text-3xl font-bold mt-1" data-ziyadah></p></div></div><div><h4 class="section-header text-base">Progres Target Wajib</h4><div class="space-y-2" data-progres-juz></div></div></div><div data-ziyadah-section class="hidden"><h4 class="section-header text-base">Progres Ziyadah (Tambahan)</h4><div class="space-y-2" data-progres-ziyadah></div></div></div></div><div id="analisis-aktivitas" class="analisis-tab-content hidden fade-in"><div class="glass-card rounded-xl overflow-hidden max-h-[28rem] overflow-y-auto"><table class="min-w-full"><tbody class="divide-y divide-[var(--card-border)]" data-aktivitas-terkini></tbody></table></div></div></div></div></template>
    <template id="analisis-prompt-template"><div class="text-center py-16 px-6 glass-card rounded-2xl fade-in"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><h3 class="mt-2 text-lg font-medium">Pilih Santri</h3><p class="mt-1 text-sm text-[var(--subtle-text)]">Silakan pilih nama santri di atas untuk melihat laporan progres hafalannya.</p></div></template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const Config = {
        scriptURL: 'https://script.google.com/macros/s/AKfycbyl2FCcGUtolkJIDsoiTYFKeKp8IQwHT0V3z8n1pOHH9CLiyvYZTBaimrojILJM_A-HLg/exec',
        musyrifSortOrder: ['Andi Aqillah Fadia Haswat', 'Abdullah', 'Muhammad Zhafir Setiaji'],
        deadlineJuz30Score: new Date('2026-01-03T23:59:59'),
        deadlineTahfizhTuntas: new Date('2025-09-30T23:59:59'),
        perpulanganPeriods: [
            { name: 'Periode 1', deadline: new Date('2025-08-16T13:00:00'), required: ['An-Naba', 'An-Nazi\'at'], type: 'surat' },
            { name: 'Periode 2', deadline: new Date('2025-09-06T13:00:00'), required: ['An-Naba', 'An-Nazi\'at', 'Abasa'], type: 'surat' },
            { name: 'Periode 3', deadline: new Date('2025-10-04T13:00:00'), required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir'], type: 'surat' },
            { name: 'Periode 4', deadline: new Date('2025-11-08T13:00:00'), required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin'], type: 'surat' },
            { name: 'Periode 5', deadline: new Date('2025-12-20T13:00:00'), required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin', 'Al-Insyiqaq', 'Al-Buruj', 'Ath-Thariq'], type: 'surat' },
            { name: 'Periode 6', deadline: new Date('2026-01-03T13:00:00'), required: ['juz30_setengah'], type: 'mutqin' },
        ],
        scoringTiers: [
            { score: 80, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin', 'Al-Insyiqaq', 'Al-Buruj', 'Ath-Thariq'] },
            { score: 76, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin', 'Al-Insyiqaq', 'Al-Buruj'] },
            { score: 72, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin', 'Al-Insyiqaq'] },
            { score: 64, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthoffifin'] },
            { score: 52, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor'] },
            { score: 44, required: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir'] },
            { score: 36, required: ['An-Naba', 'An-Nazi\'at', 'Abasa'] },
            { score: 24, required: ['An-Naba', 'An-Nazi\'at'] },
            { score: 12, required: ['An-Naba'] }
        ],
        santriList: [
             { id: 'santri1', nama: 'Adelio Daffa Syahrizha', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri2', nama: 'Ahmad Ahsanur Rizqi', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri3', nama: 'Arkana El Sabilly', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri4', nama: "Athaya Auza'I Mubarak", kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri5', nama: 'Dama Arza Evannova', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri6', nama: 'Danar Nizam Daniswara', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri7', nama: 'Devgan Jadid Sahlvatico', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri8', nama: 'Fariq Imtiyas Aufaa Kamil', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri9', nama: 'Firaas Izzulhaq', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri10', nama: 'Gilang Omar Fardad', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri11', nama: 'Jaladri Arif Wirasena', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri12', nama: 'Kemal Mubarak Siregar', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri13', nama: 'Khairil Nizam', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri14', nama: 'Mirza Nasyath Ahza Attaillah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri15', nama: 'Muhammad Farros Linggar Cahyono', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri16', nama: 'Muhammad Fathir Alfalah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri17', nama: 'Narendra Wibawa', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri18', nama: 'Naufal Zhafran Purnama', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri19', nama: 'Alano Faaiq Alfeno', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri20', nama: 'Arfandhika Fakhrul Islam', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri21', nama: 'Aydin Rafif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri22', nama: 'Danish Alzahid Dinasti', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri23', nama: 'Ghani Arif Witjaksono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri24', nama: 'Haidarrafid Satriaa Ardhani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri25', nama: 'Iqbal Zulfikar Al Hanif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri26', nama: 'Jangky Dausat', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri27', nama: 'Kumara Banyu Argani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri28', nama: 'M. Dede Afkar', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri29', nama: 'Mekha Ilham Lutfianto', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri30', nama: 'Muhammad Aiman Naim', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri31', nama: 'Muhammad Karel Ashiddiq', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri32', nama: 'Naufal Fahmi Darsono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri33', nama: 'Nazhif Fahreza Zuhairy', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri34', nama: 'Rais Abqari Ash Shidqi', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri35', nama: 'William Ramadhan Al Ghazali', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri36', nama: 'Zia El Ibrahim Aqeela Putra Wijaya', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri37', nama: "Ahmad Arkan Sya'Bani", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri38', nama: 'Ahmad Darwis', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri39', nama: 'Ahmad Ghozi El Muntazhor', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri40', nama: "Aldan 'Izzul Islam", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri41', nama: 'Fawwaz Elfareza Zuhri', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri42', nama: 'M. Fathan Alfarisi Harahap', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri43', nama: 'Muhammad Ahsani Taqwim', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri44', nama: 'Muhammad Ayyub Al Fatih', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri45', nama: 'Muhammad Gibran Rafassya', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri46', nama: 'Narendra Gerrardi Kusumah', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri47', nama: "Rijal Abdul'aziz", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri48', nama: 'Rizki Chandra Dewantara', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri49', nama: 'Ahmad Miqdad', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri50', nama: 'Dzaky Salman Al Farisi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri51', nama: 'Muhammad Alvi Mumtaz Brillian Hafizh', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri52', nama: 'Muhammad Mahdi Hafidz', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri53', nama: 'Muhammad Naufal Rasyid Arafi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri54', nama: 'Nahsif Ilman Hazim Purwono', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri55', nama: 'Nawwaf Bahy Rafif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri56', nama: 'Nizar Adhyatma Aryanda', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri57', nama: 'Rafa Agitananda Az Zayyan', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri58', nama: "Rafa Faeyza Fa'Iz", kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri59', nama: 'Rizqi Satria Putra Surya', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri60', nama: 'Umar Ubaidillah Tsaqif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri61', nama: 'Wildan Faiz Mahendra', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri62', nama: 'Faiq Fauzil Adhim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri63', nama: 'Fairuz Azzam Mahfuzh', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri64', nama: 'Muhammad Arkhan Attaqi', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri65', nama: 'Muhammad Daffa Naufal Alaika', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri66', nama: 'Muzakki Fairuzzaman', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri67', nama: 'Neymar Tsaqif Hikmatyar', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri68', nama: 'Rifqi Maliki', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri69', nama: "Yasykur Slamer'Abqariy", kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri70', nama: 'Zhafran Dhiaurrahman Hakim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri71', nama: 'Achmad Adi Darwis Elfaza', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri72', nama: 'Galang Afkar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri73', nama: 'Gilang Asytar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri74', nama: 'Muhammad Alif Al-Fatih', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri75', nama: 'Muhammad Faiz Ibnu Zakaria', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri76', nama: 'Muhammad Mahdi Hanafi', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri77', nama: 'Muhammad Muhdi Hafidz', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri78', nama: 'Rizqi Ahmad Altaf Zafar', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri79', nama: 'Dzaky Anthony Akbar', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri80', nama: 'Muwafaqi Amru Ahmad', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri81', nama: 'Abdul Ghani Irfan Rafif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri82', nama: 'Abid Fadhil Abiyah', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri83', nama: "Ahmad Dahlan Asy'Ari", kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri84', nama: 'Athallah Azmi Ghaisan Muhammad', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri85', nama: 'Azmi Zulfadli Syafiq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri86', nama: 'Azri Labibul Khawarizmi', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri87', nama: 'Dzar Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri88', nama: 'Fatihan Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri89', nama: 'Hisyam Nabil Pasha', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri90', nama: 'Ibadillah Kaiazmi Mubarak', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri91', nama: 'Kashvi Jabbar Azana', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri92', nama: 'Khawarizmi Fakhrulhaq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri93', nama: 'Muh. Naufal Alif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri94', nama: 'Muhammad Aghna Ilman Rafa', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri95', nama: 'Royyan Abdurrahman Ibtisam', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri96', nama: 'Sakhi Arkan Elfariza', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
        ],
        hafalanData: {
            juzPageCounts: { 'juz30_setengah': 9, '30': 20, '29': 20, '28': 20, '27': 20, '26': 20, '25': 20, '24': 20, '1': 20, '5': 20 },
            surahData: {
                '30': { list: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infithor', 'Al-Muthaffifin', 'Al-Insyiqaq', 'Al-Buruj', 'At-Thariq', 'Al-A\'la', 'Al-Ghasyiyah', 'Al-Fajr', 'Al-Balad', 'Asy-Syams', 'Al-Lail', 'Ad-Duha', 'Al-Insyirah', 'At-Tin', 'Al-\'Alaq', 'Al-Qadr', 'Al-Bayyinah', 'Az-Zalzalah', 'Al-\'Adiyat', 'Al-Qari\'ah', 'At-Takatsur', 'Al-\'Ashr', 'Al-Humazah', 'Al-Fil', 'Quraysh', 'Al-Ma\'un', 'Al-Kautsar', 'Al-Kafirun', 'An-Nasr', 'Al-Lahab', 'Al-Ikhlas', 'Al-Falaq', 'An-Nas'], pages: { 'An-Naba': 1, 'An-Nazi\'at': 1, 'Abasa': 1, 'At-Takwir': 1, 'Al-Infithor': 1, 'Al-Muthaffifin': 1, 'Al-Insyiqaq': 1, 'Al-Buruj': 1, 'At-Thariq': 1, 'Al-A\'la': 1, 'Al-Ghasyiyah': 1, 'Al-Fajr': 1, 'Al-Balad': 1, 'Asy-Syams': 0.5, 'Al-Lail': 0.5, 'Ad-Duha': 0.5, 'Al-Insyirah': 0.5, 'At-Tin': 0.5, 'Al-\'Alaq': 0.5, 'Al-Qadr': 0.5, 'Al-Bayyinah': 0.5, 'Az-Zalzalah': 0.25, 'Al-\'Adiyat': 0.25, 'Al-Qari\'ah': 0.25, 'At-Takatsur': 0.25, 'Al-\'Ashr': 0.25, 'Al-Humazah': 0.25, 'Al-Fil': 0.25, 'Quraysh': 0.25, 'Al-Ma\'un': 0.25, 'Al-Kautsar': 0.25, 'Al-Kafirun': 0.25, 'An-Nasr': 0.25, 'Al-Lahab': 0.25, 'Al-Ikhlas': 0.25, 'Al-Falaq': 0.25, 'An-Nas': 0.25 } },
                '29': { list: ['Al-Mulk', 'Al-Qolam', 'Al-Haaqqah', 'Al-Ma\'arij', 'Nuh', 'Al-Jinn', 'Al-Muzzammil', 'Al-Muddatsir', 'Al-Qiyamah', 'Al-Insaan', 'Al-Mursalat'], pages: { 'Al-Mulk': 2, 'Al-Qolam': 2, 'Al-Haaqqah': 2, 'Al-Ma\'arij': 2, 'Nuh': 2, 'Al-Jinn': 2, 'Al-Muzzammil': 1, 'Al-Muddatsir': 2, 'Al-Qiyamah': 1, 'Al-Insaan': 2, 'Al-Mursalat': 2 } },
                '28': { list: ['Al-Mujadalah', 'Al-Hasyr', 'Al-Mumtahanah', 'Ash-Shaf', 'Al-Jumu\'ah', 'Al-Munaafiquun', 'At-Taghaabun', 'At-Thalaaq', 'At-Tahriim'], pages: { 'Al-Mujadalah': 3.5, 'Al-Hasyr': 3.5, 'Al-Mumtahanah': 2.5, 'Ash-Shaf': 1.5, 'Al-Jumu\'ah': 1, 'Al-Munaafiquun': 2, 'At-Taghaabun': 2, 'At-Thalaaq': 2, 'At-Tahriim': 2 } },
                '27': { list: ['Adz-Dzaariyaat', 'Ath-Thuur', 'An-Najm', 'Al-Qamar', 'Ar-Rahmaan', 'Al-Waaqi\'ah', 'Al-Hadiid'], pages: { 'Adz-Dzaariyaat': 1.5, 'Ath-Thuur': 2.5, 'An-Najm': 2.5, 'Al-Qamar': 3, 'Ar-Rahmaan': 3, 'Al-Waaqi\'ah': 3, 'Al-Hadiid': 4.5 } },
                '26': { list: ['Al-Jatsiyah', 'Al-Ahqaaf', 'Muhammad', 'Al-Fath', 'Al-Hujuraat', 'Qaaf', 'Adz-Dzaariyaat'], pages: { 'Al-Jatsiyah': 0.5, 'Al-Ahqaaf': 4.5, 'Muhammad': 4, 'Al-Fath': 4.5, 'Al-Hujuraat': 2.5, 'Qaaf': 2.5, 'Adz-Dzaariyaat': 1.5 } },
                '25': { list: ['Fussilat', 'Asy-Syuuraa', 'Az-Zukhruf', 'Ad-Dukhaan', 'Al-Jatsiyah'], pages: { 'Fussilat': 1, 'Asy-Syuuraa': 6.5, 'Az-Zukhruf': 6.5, 'Ad-Dukhaan': 3, 'Al-Jatsiyah': 3 } },
                '24': { list: ['Az-Zumar', 'Ghafir', 'Fussilat'], pages: { 'Az-Zumar': 5.5, 'Ghafir': 9.5, 'Fussilat': 5} },
                '5': { list: ['An-Nisaa 24-26', 'An-Nisaa 27-33', 'An-Nisaa 34-37', 'An-Nisaa 38-44', 'An-Nisaa 45-51', 'An-Nisaa 52-59', 'An-Nisaa 60-65', 'An-Nisaa 66-73', 'An-Nisaa 74-79', 'An-Nisaa 80-86', 'An-Nisaa 87-91', 'An-Nisaa 92-94', 'An-Nisaa 95-101', 'An-Nisaa 102-105', 'An-Nisaa 106-113', 'An-Nisaa 114-121', 'An-Nisaa 122-127', 'An-Nisaa 128-134', 'An-Nisaa 135-140', 'An-Nisaa 141-147'], pages: { 'An-Nisaa 24-26': 1, 'An-Nisaa 27-33': 1, 'An-Nisaa 34-37': 1, 'An-Nisaa 38-44': 1, 'An-Nisaa 45-51': 1, 'An-Nisaa 52-59': 1, 'An-Nisaa 60-65': 1, 'An-Nisaa 66-73': 1, 'An-Nisaa 74-79': 1, 'An-Nisaa 80-86': 1, 'An-Nisaa 87-91': 1, 'An-Nisaa 92-94': 1, 'An-Nisaa 95-101': 1, 'An-Nisaa 102-105': 1, 'An-Nisaa 106-113': 1, 'An-Nisaa 114-121': 1, 'An-Nisaa 122-127': 1, 'An-Nisaa 128-134': 1, 'An-Nisaa 135-140': 1, 'An-Nisaa 141-147': 1} },
                '1': { list: ['Al-Fatihah', 'Al-Baqarah 1-5', 'Al-Baqarah 6-16', 'Al-Baqarah 17-24', 'Al-Baqarah 25-29', 'Al-Baqarah 30-37', 'Al-Baqarah 38-48', 'Al-Baqarah 49-57', 'Al-Baqarah 58-61', 'Al-Baqarah 62-69', 'Al-Baqarah 70-76', 'Al-Baqarah 77-83', 'Al-Baqarah 84-88', 'Al-Baqarah 89-93', 'Al-Baqarah 94-101', 'Al-Baqarah 102-105', 'Al-Baqarah 106-112', 'Al-Baqarah 113-119', 'Al-Baqarah 120-126', 'Al-Baqarah 127-134', 'Al-Baqarah 135-141'], pages: { 'Al-Fatihah': 0.5, 'Al-Baqarah 1-5': 0.5, 'Al-Baqarah 6-16': 1, 'Al-Baqarah 17-24': 1, 'Al-Baqarah 25-29': 1, 'Al-Baqarah 30-37': 1, 'Al-Baqarah 38-48': 1, 'Al-Baqarah 49-57': 1, 'Al-Baqarah 58-61': 1, 'Al-Baqarah 62-69': 1, 'Al-Baqarah 70-76': 1, 'Al-Baqarah 77-83': 1, 'Al-Baqarah 84-88': 1, 'Al-Baqarah 89-93': 1, 'Al-Baqarah 94-101': 1, 'Al-Baqarah 102-105': 1, 'Al-Baqarah 106-112': 1, 'Al-Baqarah 113-119': 1, 'Al-Baqarah 120-126': 1, 'Al-Baqarah 127-134': 1, 'Al-Baqarah 135-141': 1} }
            }
        }
    };

    const State = {
        allSetoran: [],
        santriData: [],
        classGroups: {},
        searchDebounceTimer: null,
        riwayatCurrentPage: 1,
        riwayatItemsPerPage: 20,
        filteredRiwayat: [],
    };

    const DOM = {};
    function cacheDOMElements() {
        document.querySelectorAll('[id]').forEach(el => {
            const propName = el.id.replace(/-(\w)/g, (_, p1) => p1.toUpperCase());
            DOM[propName] = el;
        });
        DOM.pages = document.querySelectorAll('.page-content');
    }

    const Utils = {
        fetchWithRetry: async (url, options, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    else throw error;
                }
            }
        },
        populateSelect: (select, options, placeholder) => {
            if (!select) return;
            select.innerHTML = '';
            if (placeholder) select.add(new Option(placeholder, ''));
            options.forEach(opt => select.add(new Option(opt.text, opt.value)));
        },
        normalizeName: (name) => (name || '').trim().toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' '),
        getProgramIcon: (program) => `<span title="${program}" class="inline-flex items-center justify-center h-5 w-5 rounded-full ${program === 'Unggulan' ? 'bg-gray-200 text-gray-800' : 'bg-purple-200 text-purple-800'} text-xs font-bold shrink-0">${program.charAt(0)}</span>`,
        getClassIcon: (kelas) => {
            const classMap = { 'A': 'bg-red-100 text-red-800', 'B': 'bg-yellow-100 text-yellow-800', 'C': 'bg-green-100 text-green-800', 'D': 'bg-green-100 text-green-800', 'G': 'bg-blue-100 text-blue-800', 'H': 'bg-blue-100 text-blue-800' };
            const colorClass = classMap[kelas.charAt(1)] || 'bg-gray-200 text-gray-800';
            return `<span title="Kelas ${kelas}" class="inline-flex items-center justify-center h-5 w-5 rounded-full ${colorClass} text-xs font-bold shrink-0">${kelas}</span>`;
        }
    };

    const UI = {
        showToast: (message, type = 'success') => {
            DOM.toastMessage.textContent = message;
            const isSuccess = type === 'success';
            DOM.toastIcon.innerHTML = isSuccess
                ? `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />`
                : `<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            DOM.toastIcon.classList.toggle('text-green-400', isSuccess);
            DOM.toastIcon.classList.toggle('text-red-400', !isSuccess);
            DOM.toast.classList.add('show');
            setTimeout(() => DOM.toast.classList.remove('show'), 3000);
        },
        switchPage: (pageId) => {
            if (!pageId) return;
            DOM.pages.forEach(p => p.classList.add('hidden'));
            DOM.skeletonContainer.classList.remove('hidden');
            
            setTimeout(() => {
                DOM.skeletonContainer.classList.add('hidden');
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    if(pageId === 'page-beranda') UI.triggerBerandaAnimations();
                }
                
                DOM.mainNav.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                DOM.mainNav.querySelector(`a[data-page="${pageId}"]`)?.classList.add('active');
            }, 150);
        },
        triggerBerandaAnimations: () => {
            document.querySelectorAll('#page-beranda .animated-card, #page-beranda .animate-slide-up').forEach((el, index) => {
                el.style.animationDelay = `${index * 100}ms`;
                el.classList.add('animate-slide-up');
            });
        },
        updateDateTime: () => {
            const now = new Date();
            DOM.datetimeContainer.innerHTML = `
                <div class="text-center space-y-1">
                    <p class="text-2xl font-bold">${now.toLocaleTimeString('id-ID', { hour12: false })}</p>
                    <p class="text-xs font-semibold text-[var(--subtle-text)]">${now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    <p class="text-xs font-semibold text-gray-500">${new Intl.DateTimeFormat('id-ID-u-ca-islamic', { day: 'numeric', month: 'long', year: 'numeric' }).format(now)}</p>
                </div>`;
        },
        renderAll: () => {
            UI.renderBeranda();
            UI.renderAnalisisPage();
            UI.filterAndRenderHistory();
            UI.renderRekap();
            UI.renderIconLegends();
        },
        renderBeranda: () => {
            const now = new Date();
            const activeSantriIds = new Set(
                State.allSetoran
                    .filter(s => {
                        const setoranDate = new Date(s.createdAt);
                        return setoranDate.getMonth() === now.getMonth() && setoranDate.getFullYear() === now.getFullYear();
                    })
                    .map(s => s.santriId)
            );
            
            const totalSantri = Config.santriList.length;
            const tuntasCount = State.santriData.filter(s => s.isTuntas).length;

            DOM.statsSantriAktif.textContent = `${activeSantriIds.size} / ${totalSantri}`;
            DOM.statsSantriTuntas.textContent = tuntasCount;
            DOM.statsSantriBelumTuntas.textContent = totalSantri - tuntasCount;

            UI.renderMutqinProgress();
            UI.renderTargetKetuntasan();
            UI.renderTuntasTracking();
            UI.renderPeringkat();
            UI.renderTargetTuntasTracking();
        },
        renderProgressCircle: (container, circleEl, detailsEl, santriList, color, checkFn) => {
            if (!container) return;
            if (santriList.length > 0) {
                container.classList.remove('hidden');
                const tuntasCount = santriList.filter(checkFn).length;
                const pct = Math.round((tuntasCount / santriList.length) * 100);
                const radius = 45, circumference = 2 * Math.PI * radius;
                const offset = circumference - (pct / 100) * circumference;
                
                circleEl.innerHTML = `
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200/80" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" />
                        <circle class="progress-ring-circle ${color}" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" style="stroke-dasharray:${circumference};stroke-dashoffset:${circumference};" />
                    </svg>
                    <span class="absolute inset-0 flex items-center justify-center text-2xl font-bold ${color}">${pct}%</span>`;
                
                setTimeout(() => circleEl.querySelector('.progress-ring-circle')?.style.setProperty('stroke-dashoffset', offset), 100);
                detailsEl.textContent = `${tuntasCount} dari ${santriList.length} santri tuntas.`;
            } else {
                container.classList.add('hidden');
            }
        },
        renderMutqinProgress: () => {
            const unggulan = State.santriData.filter(s => s.program === 'Unggulan');
            const tahfizh = State.santriData.filter(s => s.program === 'Tahfizh');
            UI.renderProgressCircle(DOM.mutqinUnggulanProgressContainer, DOM.mutqinUnggulanCircle, DOM.mutqinUnggulanDetails, unggulan, 'text-sky-500', s => s.nilai >= 100);
            UI.renderProgressCircle(DOM.mutqinJuz30ProgressContainer, DOM.mutqinJuz30Circle, DOM.mutqinJuz30Details, tahfizh, 'text-green-500', s => s.mutqinJuz.has(30));
            UI.renderProgressCircle(DOM.mutqinJuz29ProgressContainer, DOM.mutqinJuz29Circle, DOM.mutqinJuz29Details, tahfizh, 'text-amber-500', s => s.mutqinJuz.has(29));
        },
        renderTargetKetuntasan: () => {
            DOM.targetKetuntasanSection.innerHTML = `
                <h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 19v-8.25A4.5 4.5 0 017.5 6.5h9a4.5 4.5 0 014.5 4.5v8.25m-16.5 0h16.5m-16.5 0l1.65 1.65m13.2-1.65l-1.65 1.65" /></svg>Target Ketuntasan</h3>
                <div class="glass-card rounded-xl p-5"><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border-b md:border-b-0 md:border-r border-[var(--card-border)] pb-4 md:pb-0 md:pr-4">
                        <div class="flex items-center gap-3 mb-2"><div class="bg-sky-500/20 text-sky-600 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div><h4 class="text-lg font-bold">Ketuntasan Wajib</h4></div>
                        <p class="text-sm text-[var(--subtle-text)] mt-2">Mutqin Setengah Juz 30 (An-Naba' s.d. Ath-Thariq) untuk nilai 100.</p><div class="text-xs font-semibold mt-4 text-sky-800">Berlaku untuk: Unggulan & Tahfizh</div>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-2"><div class="bg-purple-500/20 text-purple-600 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div><h4 class="text-lg font-bold">Ketuntasan Program Tahfizh</h4></div>
                        <p class="text-sm text-[var(--subtle-text)] mt-2">Wajib menyelesaikan Mutqin Juz 30 & Juz 29 secara penuh.</p><div class="text-xs font-semibold mt-4 text-purple-800">Berlaku untuk: Program Tahfizh</div>
                    </div>
                </div></div>`;
        },
        renderTuntasTracking: () => {
            DOM.tuntasTrackingAccordion.innerHTML = Object.entries(State.classGroups)
                .filter(([groupName]) => !['Khusus Tahfizh', 'Seluruh Santri'].includes(groupName))
                .map(([groupName, group]) => {
                    const tuntasCount = group.santri.filter(s => s.isTuntas).length;
                    const totalCount = group.santri.length;
                    const percentage = totalCount > 0 ? Math.round((tuntasCount / totalCount) * 100) : 0;
                    const tuntasList = group.santri.filter(s => s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Belum ada</li>';
                    const belumTuntasList = group.santri.filter(s => !s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Semua tuntas</li>';
                    return `
                        <div class="glass-card rounded-lg overflow-hidden">
                            <h2 class="accordion-header"><button type="button" class="accordion-button flex items-center justify-between w-full p-4 font-semibold text-left transition-colors hover:bg-[var(--hover-bg)]">
                                <span class="font-bold">${groupName}</span>
                                <div class="flex items-center gap-2 sm:gap-4">
                                    <div class="hidden sm:flex items-center gap-2"><div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div></div><span class="text-xs font-semibold">${percentage}%</span></div>
                                    <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Tuntas: ${tuntasCount}</span>
                                    <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">Belum: ${totalCount - tuntasCount}</span>
                                    <svg class="accordion-chevron w-4 h-4 shrink-0 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </button></h2>
                            <div class="accordion-panel border-t border-[var(--card-border)] bg-white/10"><div class="p-4 pb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs">
                                <div><h5 class="font-semibold text-green-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Sudah Tuntas (${tuntasCount})</h5><ul class="space-y-1 list-disc list-inside">${tuntasList}</ul></div>
                                <div><h5 class="font-semibold text-red-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Belum Tuntas (${totalCount - tuntasCount})</h5><ul class="space-y-1 list-disc list-inside">${belumTuntasList}</ul></div>
                            </div></div>
                        </div>`;
                }).join('');
        },
        renderPeringkat: () => {
             DOM.peringkatSection.innerHTML = `
                <h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>Peringkat Santri</h3>
                <div class="glass-card p-2 rounded-xl">
                    <div class="flex bg-gray-200/80 rounded-lg p-1 space-x-1" id="peringkat-program-tabs">
                        <button class="tab-peringkat flex-1 p-2 rounded-md text-sm font-semibold" data-program="Tahfizh">Program Tahfizh</button>
                        <button class="tab-peringkat flex-1 p-2 rounded-md text-sm font-semibold" data-program="Unggulan">Program Unggulan</button>
                    </div>
                    <div id="peringkat-content" class="mt-4 p-2 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>`;
            UI.renderPeringkatContent('Tahfizh');
            DOM.peringkatSection.querySelector(`[data-program="Tahfizh"]`).classList.add('active');
        },
        renderPeringkatContent: (program) => {
            const getPeringkatHTML = (list, key, title, unit) => {
                const sortedList = [...list].sort((a, b) => (b[key] - a[key]) || (new Date(b.lastActivityDate) - new Date(a.lastActivityDate))).slice(0, 5);
                const medalColors = ['bg-yellow-400', 'bg-gray-400', 'bg-yellow-600'];
                return `
                    <div><h4 class="font-bold text-center mb-3">${title}</h4><ul class="space-y-3">
                        ${sortedList.map((s, i) => `
                            <li class="bg-white/50 p-3 rounded-lg shadow-sm flex items-center gap-4">
                                <span class="flex-shrink-0 h-8 w-8 rounded-full ${medalColors[i] || 'bg-gray-300'} flex items-center justify-center font-bold text-white text-sm">${i + 1}</span>
                                <div class="flex-grow min-w-0"><div class="flex items-center gap-1"><p class="font-semibold text-sm truncate">${s.nama}</p><div class="flex items-center shrink-0">${Utils.getClassIcon(s.kelas)}${Utils.getProgramIcon(s.program)}</div></div></div>
                                <div class="text-right flex-shrink-0"><p class="font-bold text-amber-600 text-lg">${(s[key] || 0).toFixed(key.includes('Pages') ? 1 : 0)}</p><p class="text-xs text-gray-500">${unit}</p></div>
                            </li>`).join('') || '<li class="text-center text-sm text-gray-500 col-span-1">Belum ada data.</li>'}
                    </ul><div class="text-center mt-4"><button class="view-top10-btn text-sm font-semibold text-amber-600 hover:underline" data-key="${key}" data-title="${title}" data-unit="${unit}" data-program="${program}">Lihat Top 10</button></div></div>`;
            };
            const santriList = State.santriData.filter(s => s.program === program);
            const criteria = program === 'Tahfizh'
                ? [{ key: 'setoranCount', title: 'Paling Rajin (Total Setoran)', unit: 'setoran' }, { key: 'ziyadahPages', title: 'Hafalan Terbanyak (Ziyadah)', unit: 'hlm' }]
                : [{ key: 'setoranCount', title: 'Paling Rajin (Total Setoran)', unit: 'setoran' }, { key: 'totalPagesSetor', title: 'Halaman Terbanyak', unit: 'hlm' }];
            document.getElementById('peringkat-content').innerHTML = criteria.map(c => getPeringkatHTML(santriList, c.key, c.title, c.unit)).join('');
        },
        renderPeringkatModal: (program, key, title, unit) => {
            const sortedList = State.santriData.filter(s => s.program === program).sort((a, b) => (b[key] - a[key]) || (new Date(b.lastActivityDate) - new Date(a.lastActivityDate))).slice(0, 10);
            DOM.peringkatModalTitle.textContent = `Top 10 - ${title}`;
            DOM.peringkatModalContent.innerHTML = sortedList.map((s, i) => `
                <div class="flex items-center gap-4 p-2 rounded-lg hover:bg-[var(--hover-bg)]">
                    <span class="flex-shrink-0 h-7 w-7 rounded-full bg-gray-200 flex items-center justify-center font-bold text-sm">${i + 1}</span>
                    <div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${s.nama}</p></div>
                    <div class="text-right flex-shrink-0"><p class="font-bold text-amber-600">${(s[key] || 0).toFixed(key.includes('Pages') ? 1 : 0)} ${unit}</p></div>
                </div>`).join('');
            DOM.peringkatModal.classList.remove('hidden');
        },
        renderTargetTuntasTracking: () => {
            DOM.targetTuntasTrackingSection.innerHTML = `
                <h3 class="section-header"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>Lacak Target Ketuntasan</h3>
                <div class="glass-card p-4 rounded-xl">
                    <div class="flex border-b border-[var(--input-border)]" id="target-juz-tabs">
                        <button class="tahfizh-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent hover:bg-[var(--hover-bg)]" data-target="juz30_setengah">Target Wajib (1/2 Juz 30)</button>
                        <button class="tahfizh-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent hover:bg-[var(--hover-bg)]" data-target="30">Tahfizh (Juz 30)</button>
                        <button class="tahfizh-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent hover:bg-[var(--hover-bg)]" data-target="29">Tahfizh (Juz 29)</button>
                    </div><div id="target-content" class="mt-4"></div>
                </div>`;
            UI.renderTargetContent('juz30_setengah');
            DOM.targetTuntasTrackingSection.querySelector(`[data-target="juz30_setengah"]`).classList.add('active');
        },
        renderTargetContent: (target, searchTerm = '') => {
            const contentContainer = document.getElementById('target-content');
            let santriList, checkFn;
            switch(target) {
                case 'juz30_setengah': santriList = State.santriData; checkFn = s => s.nilai >= 100; break;
                case '30': santriList = State.santriData.filter(s => s.program === 'Tahfizh'); checkFn = s => s.mutqinJuz.has(30); break;
                case '29': santriList = State.santriData.filter(s => s.program === 'Tahfizh'); checkFn = s => s.mutqinJuz.has(29); break;
            }
            if (!santriList) { contentContainer.innerHTML = '<p class="text-center text-gray-500">Tidak ada santri yang relevan.</p>'; return; }

            const tuntasCount = santriList.filter(checkFn).length, totalCount = santriList.length;
            const percentage = totalCount > 0 ? Math.round((tuntasCount / totalCount) * 100) : 0;
            const lowerSearchTerm = searchTerm.toLowerCase();
            const tuntasList = santriList.filter(s => checkFn(s) && s.nama.toLowerCase().includes(lowerSearchTerm));
            const belumTuntasList = santriList.filter(s => !checkFn(s) && s.nama.toLowerCase().includes(lowerSearchTerm));

            const generateList = (list) => list.map(s => `<li class="flex items-center justify-between"><span>- ${s.nama}</span><div class="flex items-center shrink-0">${Utils.getClassIcon(s.kelas)}${Utils.getProgramIcon(s.program)}</div></li>`).join('') || '<li class="text-gray-500">Tidak ada</li>';
            
            contentContainer.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-2"><span class="text-sm font-semibold">Progres: ${tuntasCount} / ${totalCount} Santri</span><span class="text-sm font-bold text-amber-700">${percentage}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-amber-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                </div>
                <div class="mt-4 relative"><input type="search" data-target-filter="${target}" value="${searchTerm}" class="target-search w-full pl-10 pr-4 py-2 text-sm glass-input rounded-lg" placeholder="Cari nama santri..."><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><h5 class="font-semibold text-green-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Sudah Tuntas (${tuntasList.length})</h5><ul class="text-sm space-y-2 h-48 overflow-y-auto pr-2">${generateList(tuntasList)}</ul></div>
                    <div><h5 class="font-semibold text-red-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Belum Tuntas (${belumTuntasList.length})</h5><ul class="text-sm space-y-2 h-48 overflow-y-auto pr-2">${generateList(belumTuntasList)}</ul></div>
                </div>`;
        },
        filterAndRenderHistory: () => {
            const searchTerm = DOM.searchRiwayat.value.toLowerCase();
            const programFilter = DOM.filterProgram.value;
            const classFilter = DOM.filterKelas.value;
            const startDate = DOM.filterTanggalMulai.value ? new Date(DOM.filterTanggalMulai.value) : null;
            const endDate = DOM.filterTanggalAkhir.value ? new Date(DOM.filterTanggalAkhir.value) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);
            if (endDate) endDate.setHours(23, 59, 59, 999);

            State.filteredRiwayat = State.allSetoran.filter(setoran => {
                const santri = State.santriData.find(st => st.id === setoran.santriId);
                if (!santri) return false;
                const classMatch = (classFilter === 'Semua') || (classFilter === '2CDGH' ? ['2C', '2D', '2G', '2H'].includes(santri.kelas) : santri.kelas === classFilter);
                const dateMatch = (!startDate || new Date(setoran.createdAt) >= startDate) && (!endDate || new Date(setoran.createdAt) <= endDate);
                return setoran.namaSantri.toLowerCase().includes(searchTerm) && (programFilter === 'Semua' || santri.program === programFilter) && classMatch && dateMatch;
            }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            UI.renderHistoryTable();
        },
        renderHistoryTable: () => {
            const totalItems = State.filteredRiwayat.length;
            const totalPages = Math.ceil(totalItems / State.riwayatItemsPerPage) || 1;
            State.riwayatCurrentPage = Math.min(State.riwayatCurrentPage, totalPages);
            const pageItems = State.filteredRiwayat.slice((State.riwayatCurrentPage - 1) * State.riwayatItemsPerPage, State.riwayatCurrentPage * State.riwayatItemsPerPage);

            const tableBody = DOM.setoranTableBody;
            if (pageItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
            } else {
                const fragment = document.createDocumentFragment();
                const template = DOM.historyRowTemplate;
                pageItems.forEach(setoran => {
                    const santri = State.santriData.find(s => s.id === setoran.santriId);
                    const clone = template.content.cloneNode(true);
                    clone.querySelector('.data-nama').textContent = setoran.namaSantri;
                    clone.querySelector('.data-jenis').textContent = setoran.jenis;
                    clone.querySelector('.data-juz-text').textContent = String(setoran.juz) === "juz30_setengah" ? "Setengah Juz 30" : `Juz ${setoran.juz}`;
                    clone.querySelector('.data-unit').textContent = setoran.halaman ? `${setoran.halaman} hlm` : setoran.surat;
                    clone.querySelector('.data-tanggal').textContent = new Date(setoran.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    if (santri) clone.querySelector('.data-icons').innerHTML = `${Utils.getClassIcon(santri.kelas)}${Utils.getProgramIcon(santri.program)}`;
                    fragment.appendChild(clone);
                });
                tableBody.innerHTML = '';
                tableBody.appendChild(fragment);
            }
            UI.renderRiwayatPagination(totalItems, totalPages);
        },
        renderRiwayatPagination: (totalItems, totalPages) => {
            const { riwayatCurrentPage: currentPage, riwayatItemsPerPage: perPage } = State;
            const startItem = totalItems > 0 ? (currentPage - 1) * perPage + 1 : 0;
            const endItem = Math.min(currentPage * perPage, totalItems);

            let pageButtons = '';
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            if (endPage - startPage + 1 < maxButtons) startPage = Math.max(1, endPage - maxButtons + 1);

            for (let i = startPage; i <= endPage; i++) {
                pageButtons += `<button class="pagination-btn h-8 w-8 rounded-md border border-gray-300 ${i === currentPage ? 'active' : 'bg-white'}" data-page="${i}">${i}</button>`;
            }

            DOM.riwayatPagination.innerHTML = `
                <span class="font-semibold text-gray-600">Menampilkan ${startItem}-${endItem} dari ${totalItems}</span>
                <div class="flex items-center gap-2">
                    <button class="pagination-btn prev-page-btn p-2 rounded-md border border-gray-300 bg-white" ${currentPage === 1 ? 'disabled' : ''}><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    ${pageButtons}
                    <button class="pagination-btn next-page-btn p-2 rounded-md border border-gray-300 bg-white" ${currentPage === totalPages ? 'disabled' : ''}><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>`;
        },
        renderRekap: () => {
            const groupOrder = ['Seluruh Santri', 'Khusus Tahfizh', ...Object.keys(State.classGroups).filter(g => !['Seluruh Santri', 'Khusus Tahfizh'].includes(g)).sort()];
            Utils.populateSelect(DOM.rekapSelect, groupOrder.map(name => ({ text: name, value: name.replace(/, /g, '').replace(/ /g, '-') })));
            
            DOM.rekapContentContainer.innerHTML = '';
            groupOrder.forEach((groupName, index) => {
                const tabId = groupName.replace(/, /g, '').replace(/ /g, '-');
                const content = DOM.rekapContentTemplate.content.cloneNode(true).querySelector('.rekap-tab-content');
                content.id = `rekap-tab-${tabId}`;
                const group = State.classGroups[groupName];
                content.querySelector('.data-title').textContent = `Rekap Capaian - ${groupName}`;
                content.querySelector('.data-musyrif').textContent = `Musyrif: ${group.musyrif}`;
                content.querySelector('.data-timestamp').textContent = `Diperbarui: ${new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}`;
                if (index !== 0) content.classList.add('hidden');
                DOM.rekapContentContainer.appendChild(content);
                UI.renderSingleRekapTable(groupName, { isInitial: true });
            });
        },
        renderSingleRekapTable: (groupName, options = {}) => {
            const group = State.classGroups[groupName]; if (!group) return;
            const contentDiv = document.getElementById(`rekap-tab-${groupName.replace(/, /g, '').replace(/ /g, '-')}`); if (!contentDiv) return;
            
            if (options.isInitial && !group.sortState) group.sortState = { column: 'nama', dir: 'asc' };
            const { column, dir } = group.sortState;
            
            group.santri.sort((a, b) => {
                const valA = column === 'nama' ? a.nama : (column === 'nilai' ? a.nilaiTampil : (column === 'ziyadah' ? (a.program === 'Tahfizh' ? a.ziyadahPages : -1) : a.isTuntas));
                const valB = column === 'nama' ? b.nama : (column === 'nilai' ? b.nilaiTampil : (column === 'ziyadah' ? (b.program === 'Tahfizh' ? b.ziyadahPages : -1) : b.isTuntas));
                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return a.nama.localeCompare(b.nama);
            });

            contentDiv.querySelectorAll('th.sortable').forEach(th => {
                const iconSpan = th.querySelector('.sort-icon');
                if (th.dataset.sort === column) {
                    iconSpan.innerHTML = dir === 'asc' ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
                } else {
                    iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12L3 8m4 8l4-8" /></svg>`;
                }
            });

            contentDiv.querySelector('.data-table-body').innerHTML = group.santri.map((santri, idx) => `
                <tr class="hover:bg-[var(--hover-bg)]">
                    <td class="px-4 py-3 text-sm text-gray-500">${idx + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium"><div class="flex items-center gap-2"><span class="truncate">${santri.nama}</span><div class="flex items-center shrink-0">${Utils.getClassIcon(santri.kelas)}${Utils.getProgramIcon(santri.program)}</div></div></td>
                    <td class="px-4 py-3 font-semibold text-center">${santri.nilaiTampil ?? 0}</td>
                    <td class="px-4 py-3 font-semibold text-center">${santri.program === 'Tahfizh' ? (santri.ziyadahPages || 0).toFixed(1) : '-'}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${santri.isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${santri.isTuntas ? 'Tuntas' : 'Belum Tuntas'}</span></td>
                </tr>`).join('');
        },
        renderAnalisisPage: () => {
            const santriOptions = State.santriData.sort((a, b) => a.nama.localeCompare(b.nama)).map(s => ({ text: s.nama, value: s.id }));
            Utils.populateSelect(DOM.santriSelectAnalisis, santriOptions, 'Pilih nama santri...');
            DOM.analisisContentContainer.innerHTML = DOM.analisisPromptTemplate.innerHTML;
        },
        renderSantriDashboard: (santriId) => {
            const santri = State.santriData.find(s => s.id === santriId);
            if (!santri) return;

            const dashboard = DOM.analisisDashboardTemplate.content.cloneNode(true);
            dashboard.querySelector('[data-name]').textContent = santri.nama;
            dashboard.querySelector('[data-kelas-text]').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Kelas ${santri.kelas}`;
            dashboard.querySelector('[data-program-text]').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg> ${santri.program}`;
            
            const statusBadge = dashboard.querySelector('[data-status-badge]');
            statusBadge.textContent = santri.isTuntas ? 'Tuntas' : 'Proses';
            statusBadge.className = `mt-1 text-xs font-bold px-3 py-1 rounded-full inline-block ${santri.isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
            
            const perpulanganBadge = dashboard.querySelector('[data-perpulangan-badge]');
            if (santri.statusPerpulangan === 'Boleh Pulang') {
                perpulanganBadge.textContent = 'Boleh Pulang';
                perpulanganBadge.className = 'mt-1 text-xs font-bold px-3 py-1 rounded-full inline-block bg-green-100 text-green-800';
            } else {
                perpulanganBadge.textContent = 'Belum Boleh Pulang';
                perpulanganBadge.className = 'mt-1 text-xs font-bold px-3 py-1 rounded-full inline-block bg-red-100 text-red-800';
            }

            dashboard.querySelector('[data-nilai]').textContent = santri.nilaiTampil;
            dashboard.querySelector('[data-ziyadah]').textContent = santri.program === 'Tahfizh' ? `${(santri.ziyadahPages || 0).toFixed(1)} hlm` : '-';
            dashboard.querySelector('[data-total-setoran]').textContent = santri.setoranCount;
            
            const progresItems = [
                { juz: 'Setengah Juz 30', done: santri.nilai >= 100 },
                { juz: 'Mutqin Juz 30', done: santri.mutqinJuz.has(30), tahfizhOnly: true },
                { juz: 'Mutqin Juz 29', done: santri.mutqinJuz.has(29), tahfizhOnly: true }
            ];
            dashboard.querySelector('[data-progres-juz]').innerHTML = progresItems
                .filter(item => !item.tahfizhOnly || santri.program === 'Tahfizh')
                .map(item => `<div class="flex items-center justify-between p-3 bg-white/50 rounded-lg"><span class="font-medium text-sm">${item.juz}</span>${item.done ? '<span class="flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-800"><svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Selesai</span>' : '<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">Proses</span>'}</div>`).join('');
            
            const ziyadahSection = dashboard.querySelector('[data-ziyadah-section]');
            if(santri.program === 'Tahfizh' && santri.isTuntas){
                ziyadahSection.classList.remove('hidden');
                const ziyadahContainer = dashboard.querySelector('[data-progres-ziyadah]');
                const allJuz = Object.keys(Config.hafalanData.juzPageCounts).filter(j => !['juz30_setengah', '30', '29'].includes(j));
                ziyadahContainer.innerHTML = allJuz.map(juz => {
                    const completedPages = santri.ziyadahProgress[juz] || 0;
                    if (completedPages <= 0) return '';
                    const totalPages = Config.hafalanData.juzPageCounts[juz];
                    const percentage = totalPages > 0 ? Math.min(100, (completedPages / totalPages) * 100).toFixed(0) : 0;
                    return `<div><div class="flex justify-between mb-1 text-sm"><span class="font-medium">Juz ${juz}</span><span>${completedPages.toFixed(1)} / ${totalPages} hlm</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
                }).join('');
            }

            const aktivitasContainer = dashboard.querySelector('[data-aktivitas-terkini]');
            const allActivities = santri.setoran.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            aktivitasContainer.innerHTML = allActivities.length > 0
                ? allActivities.map(s => `
                    <tr class="hover:bg-[var(--hover-bg)]"><td class="p-3"><p class="font-semibold text-sm">${s.jenis} ${String(s.juz) === 'juz30_setengah' ? '1/2 Juz 30' : `Juz ${s.juz}`}</p><p class="text-xs text-[var(--subtle-text)]">${s.halaman ? `${s.halaman} hlm` : s.surat}</p></td><td class="p-3 text-right text-xs text-[var(--subtle-text)]">${new Date(s.createdAt).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}</td></tr>`).join('')
                : `<tr><td class="p-4 text-center text-gray-500">Belum ada aktivitas.</td></tr>`;

            DOM.analisisContentContainer.innerHTML = '';
            DOM.analisisContentContainer.appendChild(dashboard);
            DOM.analisisContentContainer.querySelector('.analisis-tab').classList.add('active');
        },
        renderIconLegends: () => {
            const legendHtml = `<div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-[var(--subtle-text)]"><span class="font-semibold">Legenda:</span>
                <div class="flex items-center gap-1">${Utils.getProgramIcon('Unggulan')}<span>Unggulan</span></div><div class="flex items-center gap-1">${Utils.getProgramIcon('Tahfizh')}<span>Tahfizh</span></div>
                <div class="flex items-center gap-1">${Utils.getClassIcon('2A')}<span>Kelas 2A</span></div><div class="flex items-center gap-1">${Utils.getClassIcon('2B')}<span>Kelas 2B</span></div>
                <div class="flex items-center gap-1">${Utils.getClassIcon('2C')}<span>Kelas 2C/D</span></div><div class="flex items-center gap-1">${Utils.getClassIcon('2H')}<span>Kelas 2G/H</span></div></div>`;
            if(DOM.iconLegendRiwayat) DOM.iconLegendRiwayat.innerHTML = legendHtml;
            if(DOM.iconLegendRekap) DOM.iconLegendRekap.innerHTML = legendHtml;
        },
        renderStatListModal: (statType) => {
            let title = '';
            let santriList = [];
            const now = new Date();

            switch(statType) {
                case 'aktif':
                    title = 'Santri Aktif Bulan Ini';
                    const activeSantriIds = new Set(
                        State.allSetoran
                            .filter(s => {
                                const setoranDate = new Date(s.createdAt);
                                return setoranDate.getMonth() === now.getMonth() && setoranDate.getFullYear() === now.getFullYear();
                            })
                            .map(s => s.santriId)
                    );
                    santriList = State.santriData.filter(s => activeSantriIds.has(s.id));
                    break;
                case 'tuntas':
                    title = 'Santri Sudah Tuntas';
                    santriList = State.santriData.filter(s => s.isTuntas);
                    break;
                case 'belum-tuntas':
                    title = 'Santri Belum Tuntas';
                    santriList = State.santriData.filter(s => !s.isTuntas);
                    break;
            }

            DOM.statListModalTitle.textContent = `${title} (${santriList.length})`;
            const contentEl = DOM.statListModalContent;
            contentEl.innerHTML = '';

            if (santriList.length > 0) {
                const list = document.createElement('ul');
                list.className = 'space-y-2 list-decimal list-inside';
                santriList.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(s => {
                    const item = document.createElement('li');
                    item.className = 'p-2 rounded-md hover:bg-[var(--hover-bg)]';
                    item.textContent = s.nama;
                    list.appendChild(item);
                });
                contentEl.appendChild(list);
            } else {
                contentEl.innerHTML = '<p class="text-center text-gray-500">Tidak ada santri untuk ditampilkan.</p>';
            }
            
            DOM.statListModal.classList.remove('hidden');
        }
    };

    const Core = {
        reloadData: async () => {
            try {
                const dataFromServer = await Utils.fetchWithRetry(Config.scriptURL);
                State.allSetoran = dataFromServer.map(item => {
                    const santriId = State.santriNameMap.get(Utils.normalizeName(item.namaSantri || ''));
                    if (!santriId) console.warn(`Nama santri tidak ditemukan: "${item.namaSantri}"`);
                    return { ...item, id: `row-${item.rowNumber}`, santriId, createdAt: item.tanggal };
                }).filter(item => item.santriId);
                Core.calculateAllSantriStats();
                Core.buildClassGroups();
                UI.renderAll();
            } catch (error) {
                console.error('Gagal memuat data setoran setelah beberapa kali percobaan:', error);
                UI.showToast('Gagal memuat riwayat setoran.', 'error');
            }
        },
        checkPerpulanganStatus: (santri) => {
            // Permanent statuses (priority)
            const hasMutqinSetengahJuz = santri.setoran.some(s => s.jenis === 'Mutqin' && String(s.juz) === "juz30_setengah");
            if (hasMutqinSetengahJuz) return 'Boleh Pulang';

            const hasMutqinJuz30 = santri.setoran.some(s => s.jenis === 'Mutqin' && s.juz == 30);
            if (hasMutqinJuz30) return 'Boleh Pulang';

            // Check timed periods
            for (const period of Config.perpulanganPeriods) {
                let conditionMet = false;
                if (period.type === 'surat') {
                    conditionMet = period.required.every(requiredSurah =>
                        santri.setoran.some(s =>
                            s.surat === requiredSurah && new Date(s.createdAt) <= period.deadline
                        )
                    );
                } else if (period.type === 'mutqin') {
                    conditionMet = santri.setoran.some(s =>
                        s.jenis === 'Mutqin' && period.required.includes(String(s.juz)) && new Date(s.createdAt) <= period.deadline
                    );
                }

                if (conditionMet) {
                    return 'Boleh Pulang';
                }
            }

            return 'Belum Boleh Pulang';
        },
        calculateAllSantriStats: () => {
            const santriStatsMap = new Map(Config.santriList.map(s => [s.id, { ...s, mutqinJuz: new Set(), nilai: 0, nilaiTampil: 0, isTuntas: false, tuntasDate: null, ziyadahPages: 0, setoran: [], setoranCount: 0, mutqinPages: 0, totalPagesSetor: 0, lastActivityDate: null, ziyadahProgress: {}, statusPerpulangan: 'Belum Boleh Pulang' }]));
            
            State.allSetoran.forEach(setoran => {
                const santri = santriStatsMap.get(setoran.santriId);
                if (santri) {
                    santri.setoran.push(setoran);
                    santri.setoranCount++;
                    const setoranDate = new Date(setoran.createdAt);
                    if (!santri.lastActivityDate || setoranDate > santri.lastActivityDate) santri.lastActivityDate = setoranDate;
                }
            });
            
            santriStatsMap.forEach(santri => {
                if (santri.setoran.length === 0) return;

                const mutqinSetengahJuz = santri.setoran.find(s => s.jenis === 'Mutqin' && String(s.juz) === "juz30_setengah");
                const mutqinJuz30 = santri.setoran.find(s => s.jenis === 'Mutqin' && s.juz == 30 && (!s.halaman || parseInt(s.halaman) >= Config.hafalanData.juzPageCounts['30']));
                const mutqinJuz29 = santri.setoran.find(s => s.jenis === 'Mutqin' && s.juz == 29 && (!s.halaman || parseInt(s.halaman) >= Config.hafalanData.juzPageCounts['29']));

                if (mutqinJuz30) santri.mutqinJuz.add(30);
                if (mutqinJuz29) santri.mutqinJuz.add(29);

                // New scoring logic
                let calculatedScore = 0;
                if (mutqinJuz30 || mutqinSetengahJuz) {
                    calculatedScore = 100;
                } else {
                    const setoranSurahs = new Set(santri.setoran.filter(s => s.juz == 30 && s.surat).map(s => s.surat));
                    for (const tier of Config.scoringTiers) {
                        if (tier.required.every(surah => setoranSurahs.has(surah))) {
                            calculatedScore = tier.score;
                            break;
                        }
                    }
                }
                santri.nilai = calculatedScore;
                
                const isUnggulanTuntas = santri.program === 'Unggulan' && santri.nilai >= 100;
                const isTahfizhTuntas = santri.program === 'Tahfizh' && santri.nilai >= 100 && santri.mutqinJuz.has(29) && santri.mutqinJuz.has(30) &&
                                       (mutqinJuz29 && new Date(mutqinJuz29.createdAt) <= Config.deadlineTahfizhTuntas) &&
                                       (mutqinJuz30 && new Date(mutqinJuz30.createdAt) <= Config.deadlineTahfizhTuntas);
                santri.isTuntas = isUnggulanTuntas || isTahfizhTuntas;

                santri.totalPagesSetor = santri.setoran.reduce((sum, s) => sum + (parseFloat(s.halaman) || 0), 0);
                if (santri.program === 'Unggulan') {
                    if (mutqinJuz30) {
                        santri.totalPagesSetor = Math.max(santri.totalPagesSetor, 20);
                    } else if (mutqinSetengahJuz) {
                        santri.totalPagesSetor = Math.max(santri.totalPagesSetor, 9);
                    }
                }
                
                santri.setoran.filter(s => s.jenis === 'Ziyadah').forEach(s => {
                    const pageValue = (s.halaman ? parseFloat(s.halaman) : Config.hafalanData.surahData[s.juz]?.pages[s.surat]) || 0;
                    santri.ziyadahPages += pageValue;
                    santri.ziyadahProgress[s.juz] = (santri.ziyadahProgress[s.juz] || 0) + pageValue;
                });
                santri.nilaiTampil = santri.nilai; // Use the new score directly
                santri.statusPerpulangan = Core.checkPerpulanganStatus(santri);
            });
            State.santriData = Array.from(santriStatsMap.values());
        },
        buildClassGroups: () => {
            const tempGroups = {};
            State.santriData.forEach(s => {
                const key = s.musyrif || 'Tanpa Musyrif';
                if (!tempGroups[key]) tempGroups[key] = { santri: [], musyrif: key, classes: new Set() };
                tempGroups[key].santri.push(s);
                tempGroups[key].classes.add(s.kelas);
            });
            State.classGroups = {};
            for (const musyrif in tempGroups) {
                const group = tempGroups[musyrif];
                const groupName = (musyrif === 'Muhammad Zhafir Setiaji') ? '2CDGH' : [...group.classes].sort().join(', ');
                State.classGroups[groupName] = { santri: group.santri, musyrif: group.musyrif };
            }
            State.classGroups['Khusus Tahfizh'] = { santri: State.santriData.filter(s => s.program === 'Tahfizh'), musyrif: 'Semua Musyrif' };
            State.classGroups['Seluruh Santri'] = { santri: State.santriData, musyrif: 'Semua Musyrif' };
        }
    };

    function setupEventListeners() {
        const eventHandlers = {
            click: {
                '.nav-link': (e, el) => { e.preventDefault(); UI.switchPage(el.dataset.page); },
                '[data-target-page]': (e, el) => { e.preventDefault(); UI.switchPage(el.dataset.targetPage); },
                '#footer-help-button': (e) => { e.preventDefault(); DOM.helpModal.classList.remove('hidden'); },
                '#closeHelpModal, #helpModal .modal-backdrop': () => DOM.helpModal.classList.add('hidden'),
                '#closePeringkatModal, #peringkatModal .modal-backdrop': () => DOM.peringkatModal.classList.add('hidden'),
                '#closeStatListModal, #statListModal .modal-backdrop': () => DOM.statListModal.classList.add('hidden'),
                '.stat-card[data-stat-type]': (e, el) => UI.renderStatListModal(el.dataset.statType),
                '.accordion-button': (e, el) => {
                    const panel = el.closest('h2').nextElementSibling;
                    const isOpen = panel.style.maxHeight && panel.style.maxHeight !== '0px';
                    panel.style.maxHeight = isOpen ? null : `${panel.scrollHeight}px`;
                    el.querySelector('.accordion-chevron').classList.toggle('rotate-180', !isOpen);
                },
                '.sortable': (e, el) => {
                    const column = el.dataset.sort;
                    const groupName = Object.keys(State.classGroups).find(n => n.replace(/, /g, '').replace(/ /g, '-') === el.closest('.rekap-tab-content').id.replace('rekap-tab-', ''));
                    if (groupName) {
                        const group = State.classGroups[groupName];
                        const isSameColumn = group.sortState?.column === column;
                        group.sortState = { column, dir: isSameColumn && group.sortState?.dir === 'asc' ? 'desc' : 'asc' };
                        UI.renderSingleRekapTable(groupName);
                    }
                },
                '.tab-peringkat': (e, el) => {
                    document.querySelectorAll('.tab-peringkat').forEach(b => b.classList.remove('active'));
                    el.classList.add('active');
                    UI.renderPeringkatContent(el.dataset.program);
                },
                '#target-juz-tabs .tahfizh-tab': (e, el) => {
                    document.querySelectorAll('#target-juz-tabs .tahfizh-tab').forEach(b => b.classList.remove('active'));
                    el.classList.add('active');
                    UI.renderTargetContent(el.dataset.target);
                },
                '.view-top10-btn': (e, el) => {
                    const { program, key, title, unit } = el.dataset;
                    UI.renderPeringkatModal(program, key, title, unit);
                },
                '.analisis-tab': (e, el) => {
                    const targetId = el.dataset.target;
                    el.parentElement.querySelectorAll('.analisis-tab').forEach(t => t.classList.remove('active'));
                    el.classList.add('active');
                    DOM.analisisContentContainer.querySelectorAll('.analisis-tab-content').forEach(c => c.classList.add('hidden'));
                    DOM.analisisContentContainer.querySelector(`#${targetId}`).classList.remove('hidden');
                },
                '.pagination-btn': (e, el) => {
                    const totalPages = Math.ceil(State.filteredRiwayat.length / State.riwayatItemsPerPage);
                    if (el.classList.contains('prev-page-btn')) { if (State.riwayatCurrentPage > 1) State.riwayatCurrentPage--; }
                    else if (el.classList.contains('next-page-btn')) { if (State.riwayatCurrentPage < totalPages) State.riwayatCurrentPage++; }
                    else { State.riwayatCurrentPage = parseInt(el.dataset.page, 10); }
                    UI.renderHistoryTable();
                }
            },
            input: {
                '.target-search': (e) => {
                    clearTimeout(State.searchDebounceTimer);
                    State.searchDebounceTimer = setTimeout(() => UI.renderTargetContent(e.target.dataset.targetFilter, e.target.value), 300);
                },
                '#search-riwayat, #filter-program, #filter-kelas, #filter-tanggal-mulai, #filter-tanggal-akhir': () => {
                    State.riwayatCurrentPage = 1;
                    UI.filterAndRenderHistory();
                }
            },
            change: {
                '#rekap-select': (e) => {
                    DOM.rekapContentContainer.querySelectorAll('.rekap-tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`rekap-tab-${e.target.value}`)?.classList.remove('hidden');
                },
                '#santri-select-analisis': (e) => {
                    if (e.target.value) UI.renderSantriDashboard(e.target.value);
                    else DOM.analisisContentContainer.innerHTML = DOM.analisisPromptTemplate.innerHTML;
                }
            }
        };

        for (const eventType in eventHandlers) {
            document.body.addEventListener(eventType, (e) => {
                for (const selector in eventHandlers[eventType]) {
                    if (e.target.closest(selector)) {
                        eventHandlers[eventType][selector](e, e.target.closest(selector));
                        break;
                    }
                }
            });
        }
    }

    async function main() {
        cacheDOMElements();
        setupEventListeners();
        UI.switchPage('page-beranda');
        UI.updateDateTime();
        setInterval(UI.updateDateTime, 1000);
        State.santriNameMap = new Map(Config.santriList.map(s => [Utils.normalizeName(s.nama), s.id]));
        await Core.reloadData();
        UI.switchPage('page-beranda');
    }

    main();
});
</script>
</body>
</html>
